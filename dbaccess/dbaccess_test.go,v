head	1.2;
access;
symbols;
locks
	llonergan:1.2; strict;
comment	@# @;


1.2
date	2022.07.13.17.46.54;	author llonergan;	state Exp;
branches;
next	1.1;

1.1
date	2022.07.11.17.37.50;	author llonergan;	state Exp;
branches;
next	;


desc
@@


1.2
log
@.
@
text
@package dbaccess

import (
    "database/sql"
    "fmt"
    "testing"
)

func TestDB(t *testing.T) {
    var (
        err   error
        stmt  *sql.Stmt
        db    *DB
        res   sql.Result
        id, a int64
        rows  *sql.Rows
    )

    // db = NewDB("mysql", "root:root@@tcp(localhost:3306)/mysql")
    CreateDatabase("mysql", "root", "root", "localhost", "apitest", 3306)

    db = NewDB("mysql", "root", "root", "localhost", "apitest", 3306)
    // close database after all work is done
    defer db.Close()

    db.Ping()
    db.Exec("create table posts(id INT, Name TEXT, Text TEXT)")

    // INSERT INTO DB
    // prepare
    stmt = db.Prepare("insert into posts(id, Name, Text) values (?, ?, ?)")

    // execute
    res, err = stmt.Exec("5", "Post five", "Contents of post 5")
    ErrorCheck(err)

    id, err = res.LastInsertId()
    ErrorCheck(err)

    fmt.Println("Insert id", id)

    // Update db
    stmt = db.Prepare("update posts set Text=? where id=?")

    // execute
    res, err = stmt.Exec("This is post five", "5")
    ErrorCheck(err)

    a, err = res.RowsAffected()
    ErrorCheck(err)

    fmt.Println(a)

    // query all data
    rows = db.Query("select * from posts")
    ErrorCheck(err)

    var post = Post{}

    for rows.Next() {
        err = rows.Scan(&post.Id, &post.Name, &post.Text)
        ErrorCheck(err)
        fmt.Println(post)
    }

    // delete data
    stmt = db.Prepare("delete from posts where id=?")
    ErrorCheck(err)

    // delete 5th post
    res, err = stmt.Exec("5")
    ErrorCheck(err)

    // affected rows
    a, err = res.RowsAffected()
    ErrorCheck(err)

    fmt.Println(a) // 1
}

func ErrorCheck(err error) {
    if err != nil {
        panic(err.Error())
    }
}
@


1.1
log
@.
@
text
@d19 2
a20 4
    db = NewDB("mysql", "root:root@@tcp(localhost:3306)/mysql")
    db.EXEC("drop database if exists apitest")
    db.EXEC("create database apitest")
    db.CLOSE()
d22 1
a22 1
    db = NewDB("mysql", "root:root@@tcp(localhost:3306)/apitest")
d24 1
a24 1
    defer db.CLOSE()
d26 2
a27 2
    db.PING()
    db.EXEC("create table posts(id INT, Name TEXT, Text TEXT)")
d31 1
a31 1
    stmt = db.PREPARE("insert into posts(id, Name, Text) values (?, ?, ?)")
d43 1
a43 1
    stmt = db.PREPARE("update posts set Text=? where id=?")
d55 1
a55 1
    rows = db.QUERY("select * from posts")
d67 1
a67 1
    stmt = db.PREPARE("delete from posts where id=?")
@
